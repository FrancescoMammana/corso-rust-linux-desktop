<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progetto: Client HTTP | Corso Rust Linux Desktop</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="rust-logo">ü¶Ä</div>
            <h1>Corso Completo: Sviluppo Applicazioni Desktop Linux in Rust</h1>
        </div>
        <button class="menu-toggle" aria-label="Menu">‚ò∞</button>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h3>üìö Corso</h3>
            <ul><li><a href="index.html">üè† Home</a></li></ul>
            <h3>1. Ambiente</h3>
            <ul><li><a href="lesson-1-1.html">1.1 Installazione Rust</a></li>
            <li><a href="lesson-1-2.html">1.2 Config VS Code</a></li>
            <li><a href="lesson-1-3.html">1.3 Strumenti Extra</a></li></ul>
            <h3>2. Rust Base</h3>
            <ul><li><a href="lesson-2-1.html">2.1 Sintassi</a></li>
            <li><a href="lesson-2-2.html">2.2 Controllo</a></li>
            <li><a href="lesson-2-3.html">2.3 Progetto</a></li>
            <li><a href="lesson-2-4.html">2.4 Crate</a></li></ul>
            <h3>3. GUI</h3>
            <ul><li><a href="lesson-3-1.html">3.1 GTK-rs</a></li>
            <li><a href="lesson-3-2.html">3.2 Glade</a></li>
            <li><a href="lesson-3-3.html">3.3 Manuale</a></li>
            <li><a href="lesson-3-4.html">3.4 Widget</a></li>
            <li><a href="lesson-3-5.html">3.5 Menu</a></li></ul>
            <h3>4. Progetti</h3>
            <ul><li><a href="lesson-4-1.html">4.1 Editor</a></li>
            <li><a href="lesson-4-2.html">4.2 Note DB</a></li>
            <li><a href="lesson-4-3.html">4.3 HTTP</a></li></ul>
            <h3>5. GitHub</h3>
            <ul><li><a href="lesson-5-1.html">5.1 Repository</a></li>
            <li><a href="lesson-5-2.html">5.2 Documentazione</a></li>
            <li><a href="lesson-5-3.html">5.3 Testing</a></li></ul>
            <h3>üìñ Risorse</h3>
            <ul><li><a href="about.html">‚ÑπÔ∏è Info Corso</a></li>
            <li><a href="resources.html">üîó Risorse</a></li>
            <li><a href="faq.html">‚ùì FAQ</a></li></ul>
        </aside>

        <main class="content">
            <nav class="breadcrumb"><a href="index.html">Home</a> > Sezione 4: Progetti Pratici > Progetto: Client HTTP</nav>
            <h2 class="lesson-title">Progetto: Client HTTP</h2>

            <div class="box box-theory">
                <h3>üìò Introduzione Teorica</h3>
                <p><strong>Client HTTP asincrono</strong> che integra networking contemporaneo con GTK:</p>
<ul>
    <li><strong>tokio</strong>: Runtime async Rust</li>
    <li><strong>reqwest</strong>: HTTP client moderno</li>
    <li><strong>async/await</strong>: Programmazione non-blocking</li>
    <li><strong>serde_json</strong>: Parsing JSON</li>
    <li><strong>ProgressBar</strong>: Feedback download</li>
    <li><strong>Integration GTK</strong>: glib::idle_add_local per aggiornare UI</li>
    <li><strong>Error handling</strong>: Gestione errori rete</li>
</ul>
<p>Dimostra come integrare code async complesso con GTK UI senza freezare.</p>
            </div>

            <div class="box box-steps">
                <h3>üîß Procedura Passo-Passo</h3>
                <ol>
    <li><strong>Dipendenze</strong>
        <pre><code>[dependencies]
gtk = "0.18"
tokio = { version = "1", features = ["full"] }
reqwest = { version = "0.11", features = ["json"] }
serde_json = "1"</code></pre>
    </li>

    <li><strong>Async fetch function</strong>
        <pre><code>async fn fetch_url(url: &str) -> Result<String, Box<dyn std::error::Error>> {
    let response = reqwest::get(url).await?;
    Ok(response.text().await?)
}</code></pre>
    </li>

    <li><strong>UI con ProgressBar</strong>
        <pre><code>let progress = ProgressBar::new();
progress.set_fraction(0.0);  // 0%
button.connect_clicked(|_| {
    progress.set_fraction(0.5);  // 50%
});</code></pre>
    </li>

    <li><strong>Spawn async da GTK callback</strong>
        <pre><code>let runtime = Runtime::new().unwrap();
button.connect_clicked(move |_| {
    let url = entry.text().to_string();
    runtime.spawn(async move {
        match fetch_url(&url).await {
            Ok(body) => {
                glib::idle_add_local(move || {
                    textview.buffer().unwrap().set_text(&body);
                    GLib::Continue(false)
                });
            }
            Err(e) => eprintln!("Errore: {}", e),
        }
    });
});</code></pre>
    </li>
</ol>
            </div>

            <div class="box box-code">
                <h3>üíª Codice Sorgente Commentato</h3>
                <pre><code>// ========================================
// PROGETTO: CLIENT HTTP ASINCRONO
// ========================================

use gtk::prelude::*;
use gtk::{Application, ApplicationWindow, Entry, Button, 
          TextView, ProgressBar, Box, Orientation};
use tokio::runtime::Runtime;
use std::sync::Arc;

#[tokio::main]
async fn main() {
    let app = Application::builder()
        .application_id("com.example.HttpClient")
        .build();

    app.connect_activate(build_ui);
    app.run();
}

fn build_ui(app: &Application) {
    let window = ApplicationWindow::builder()
        .application(app)
        .title("HTTP Client")
        .default_width(600)
        .default_height(400)
        .build();

    let vbox = Box::new(Orientation::Vertical, 10);
    vbox.set_margin_top(10);
    vbox.set_margin_bottom(10);
    vbox.set_margin_start(10);
    vbox.set_margin_end(10);

    let entry = Entry::new();
    entry.set_placeholder_text(Some("https://api.github.com/users/rust-lang"));
    vbox.pack_start(&entry, false, false, 0);

    let fetch_btn = Button::with_label("üåê Fetch");
    vbox.pack_start(&fetch_btn, false, false, 0);

    let progress = ProgressBar::new();
    progress.set_fraction(0.0);
    vbox.pack_start(&progress, false, false, 0);

    let textview = TextView::new();
    let scrolled = gtk::ScrolledWindow::new(None::<&gtk::Adjustment>, 
                                            None::<&gtk::Adjustment>);
    scrolled.add(&textview);
    vbox.pack_start(&scrolled, true, true, 0);

    window.add(&vbox);
    window.show_all();

    // Runtime asincrono
    let runtime = Arc::new(Runtime::new().unwrap());

    fetch_btn.connect_clicked(glib::clone!(
        @weak entry, @weak progress, @weak textview => move |_| {

        let url = entry.text().to_string();
        let runtime_clone = runtime.clone();

        progress.set_fraction(0.3);

        runtime_clone.spawn(async move {
            match reqwest::get(&url).await {
                Ok(resp) => {
                    match resp.text().await {
                        Ok(body) => {
                            glib::idle_add_local(move || {
                                textview.buffer().unwrap().set_text(&body);
                                progress.set_fraction(1.0);
                                glib::Continue(false)
                            });
                        }
                        Err(e) => eprintln!("Errore body: {}", e),
                    }
                }
                Err(e) => {
                    eprintln!("Errore request: {}", e);
                    glib::idle_add_local(move || {
                        textview.buffer().unwrap().set_text(&format!("Errore: {}", e));
                        progress.set_fraction(0.0);
                        glib::Continue(false)
                    });
                }
            }
        });
    }));
}

// Helper async function
async fn fetch_data(url: &str) -> Result<String, Box<dyn std::error::Error>> {
    let response = reqwest::get(url).await?;
    Ok(response.text().await?)
}

// JSON parsing
async fn fetch_json(url: &str) -> Result<serde_json::Value, Box<dyn std::error::Error>> {
    let response = reqwest::get(url).await?;
    Ok(response.json().await?)
}
</code></pre>
            </div>

            <div class="box box-exercises">
                <h3>‚úèÔ∏è Esercizi Pratici</h3>
                <ol>
    <li><strong>GET Request Base</strong>
        <p>Fetch da API pubblica (JSONPlaceholder, GitHub API) e mostra risposta.</p>
    </li>

    <li><strong>POST Request</strong>
        <p>Invia dati con form (Entry fields) verso server e mostra risposta.</p>
    </li>

    <li><strong>Download File</strong>
        <p>Scarica file da URL con ProgressBar aggiornato durante download.</p>
    </li>

    <li><strong>JSON Deserialization</strong>
        <p>Fetch JSON, deserializza con serde in struct, mostra dati formattati.</p>
    </li>

    <li><strong>Error Handling</strong>
        <p>Gestisci timeout, error 404, connection refused con messaggi utili.</p>
    </li>

    <li><strong>Challenge: Multi-Request</strong>
        <p>Manda 5 request paralleli, aspetta tutte, mostra risultati in lista.</p>
    </li>
</ol>
            </div>

            <div class="box box-troubleshooting">
                <h3>‚ö†Ô∏è Troubleshooting</h3>
                <h4>‚ùå UI freeza durante request</h4>
<p><strong>Causa:</strong> Request bloccante nel GTK main thread.</p>
<p><strong>Soluzione:</strong> Usa tokio::spawn + glib::idle_add_local per async.</p>

<h4>‚ùå "cannot move value into async block"</h4>
<p><strong>Soluzione:</strong> Usa glib::clone! macro per catturare valori.</p>

<h4>‚ùå Timeout troppo lungo</h4>
<p><strong>Soluzione:</strong> <code>client.timeout(Duration::from_secs(10))</code></p>

<h4>üí° Tip: Abort su chiusura</h4>
<p>Salva JoinHandle e cancella con abort() se utente chiude app.</p>

<h4>üí° Tip: Retry logic</h4>
<p>Implementa retry con exponential backoff per request instabili.</p>
            </div>

            <nav class="lesson-nav">
                <a href="lesson-4-2.html">‚Üê Precedente</a>
                <a href="lesson-5-1.html">Successiva ‚Üí</a>
            </nav>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 Corso Rust Linux Desktop | Creato con ‚ù§Ô∏è per la community Rust</p>
        <p><a href="https://www.rust-lang.org" target="_blank">Rust Programming Language</a> | <a href="https://gtk-rs.org" target="_blank">GTK-rs</a></p>
    </footer>

    <script src="script.js"></script>
</body>
</html>